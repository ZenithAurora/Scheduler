# 手写React Schedule调度器 - 从零到一实现

## 项目概述

本项目旨在从零开始实现React的Scheduler调度器核心功能，通过逐步拆解官方源码，深入理解React任务调度的核心机制。

## 项目目标

- **学习React调度器核心原理**：深入理解React如何协调任务执行时机
- **掌握优先级调度机制**：实现不同优先级任务的智能调度
- **理解时间切片技术**：学习如何避免长时间任务阻塞主线程
- **实践最小堆数据结构**：掌握任务队列的高效管理

## 核心问题解决

调度器主要解决以下三个核心问题：

1. **任务优先级**：不同任务有不同的紧急程度，需要优先级调度
2. **时间切片**：长时间任务不能阻塞主线程，需要分片执行
3. **任务调度**：合理安排任务执行时机，优化用户体验

## 技术架构

### 核心数据结构
- **最小堆（Min-Heap）**：按照任务过期时间排序的任务队列
- **双队列系统**：taskQueue（立即执行队列）和timerQueue（延迟执行队列）

### 关键技术点
- **MessageChannel**：创建宏任务实现任务"中断"和恢复
- **时间切片**：通过`shouldYieldToHost`判断是否需要让出主线程
- **优先级系统**：5级优先级机制，从ImmediatePriority到IdlePriority

## 实现计划

按照官方Scheduler的结构，我们将代码拆分成多个模块：

### 第一阶段：基础架构
1. **优先级定义** - 定义5个优先级常量
2. **最小堆实现** - 任务队列的数据结构
3. **时间切片与时间管理** - 包括`shouldYieldToHost`和调度时间

### 第二阶段：核心调度
4. **任务调度核心** - 调度逻辑、任务队列管理
5. **延迟任务处理** - timerQueue的处理机制
6. **调度器API实现** - 如`scheduleCallback`、`cancelCallback`等

## 项目结构

```
Scheduler/
├── 0.readme.md                   # 项目总览和实现计划
├── 1.Priorities.js               # 优先级定义 - 定义5个优先级常量
├── 2.MinHeap.js                  # 最小堆实现 - 任务队列的数据结构
├── 3.TimeTools.js                # 时间工具 - 时间切片与时间管理
├── 4.SchedulerState.js           # 调度器状态管理 - 状态变量封装
├── 5.ShouldYieldToHost.js        # 时间切片判断 - 判断是否需要让出主线程
├── 6.AdvanceTimers.js            # 延迟任务处理 - timerQueue的处理机制
├── 7.WorkLoop.js                 # 工作循环核心 - 任务执行主循环
├── 8.PerformWorkUntilDeadline.js # 任务执行器 - 实现时间切片的工作调度
├── 9.ScheduleCallback.js         # 核心调度API - 安排任务
├── 10.CancelAndQuery.js          # 取消和查询API - 任务取消和状态查询
├── 11.PriorityControl.js         # 优先级控制 - 优先级切换和嵌套
├── 12.PaintUtils.js              # 绘制工具 - 浏览器绘制相关
├── 13.WrapCallback.js            # 回调包装 - 回调函数包装和优先级继承
├── 14.Scheduler.js               # 调度器入口 - 导出所有公共API
├── package.json                  # 项目配置
└── package-lock.json             # 依赖锁定文件
```

## 文件功能详解

### 1. 基础架构模块
- **1.Priorities.js** - 定义5个优先级常量：ImmediatePriority、UserBlockingPriority、NormalPriority、LowPriority、IdlePriority
- **2.MinHeap.js** - 实现最小堆数据结构，用于高效管理任务队列
- **3.TimeTools.js** - 提供时间相关工具函数，包括获取当前时间、计算超时时间等

### 2. 状态管理模块
- **4.SchedulerState.js** - 集中管理调度器状态，包括任务队列、当前任务、优先级等状态变量

### 3. 时间切片模块
- **5.ShouldYieldToHost.js** - 实现时间切片机制，判断是否需要让出主线程控制权
- **6.AdvanceTimers.js** - 处理延迟任务队列，将到期的延迟任务转移到立即执行队列

### 4. 核心调度模块
- **7.WorkLoop.js** - 工作循环核心，按优先级执行任务，实现时间切片
- **8.PerformWorkUntilDeadline.js** - 任务执行器，通过MessageChannel实现真正的异步调度
- **9.ScheduleCallback.js** - 核心调度API，将回调函数封装成任务对象并安排执行

### 5. 控制API模块
- **10.CancelAndQuery.js** - 提供任务取消和状态查询功能
- **11.PriorityControl.js** - 实现优先级切换和嵌套优先级控制
- **12.PaintUtils.js** - 浏览器绘制相关工具函数
- **13.WrapCallback.js** - 回调函数包装，支持优先级继承

### 6. 入口模块
- **14.Scheduler.js** - 调度器入口文件，导出所有公共API供外部使用

## 使用指南

### 安装依赖
```bash
npm install
```

### 基本使用
```javascript
import { unstable_scheduleCallback, unstable_cancelCallback } from './14.Scheduler.js';

// 安排一个普通优先级的任务
const task = unstable_scheduleCallback(
  NormalPriority, 
  () => {
    console.log('任务执行');
  }
);

// 取消任务
unstable_cancelCallback(task);
```

### 优先级使用示例
```javascript
import { 
  ImmediatePriority, 
  UserBlockingPriority, 
  NormalPriority 
} from './1.Priorities.js';

// 安排不同优先级的任务
unstable_scheduleCallback(ImmediatePriority, () => {
  // 紧急任务，立即执行
});

unstable_scheduleCallback(NormalPriority, () => {
  // 普通任务，按正常调度执行
});
```

## 技术特色

### ES6模块规范
- 所有状态变量通过状态对象和修改方法进行管理
- 符合ES6模块导入/导出规范，避免直接修改变量导致的错误

### 时间切片机制
- 通过`shouldYieldToHost`实现真正的非阻塞任务执行
- 使用MessageChannel确保真正的异步调度

### 优先级调度
- 5级优先级系统，智能安排任务执行顺序
- 支持优先级嵌套和动态切换

## 开发说明

本项目采用模块化设计，每个文件职责单一，便于理解和维护。代码中包含详细的中文注释，帮助理解React调度器的核心原理。

## 重构说明

本项目已经完成ES6模块规范的重构，所有状态变量都通过状态对象和修改方法进行管理，避免了直接修改变量导致的"Assignment to constant variable"错误。
